---
title: "カスタムドメインの裏側を覗いてみる"
emoji: "🫣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["github", "cloudflare", "DNS"]
published: true 
---

はじめまして、たなかです。私は普段、大学のエンジニアサークルで開発をしているのですが、GitHub Pages でデプロイしたサイトのカスタムドメインを Cloudflare で設定するということがあり、そこで何が起きているのかよく分からなかったので、調べてまとめてみたいと思います。

# カスタムドメインを設定する方法
カスタムドメイン自体は [GitHub の公式ドキュメント](https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site)通りにやれば簡単に設定できます。アペックスドメインとサブドメインの両方についてそれぞれ設定する方法が書かれていますが、今回はサブドメインについて詳しくみていこうと思います。サブドメインを設定する場合は、まず GitHub 側でカスタムドメインを指定します。その後 DNS プロバイダー（今回は Cloudflare ）で、指定したサブドメインが GitHub Pages のデフォルトのドメインを指すような `CNAME` レコードを作成します。例として、`www.example.com` を使用したい場合は、`www.example.com` が `<user>.github.io` を指すような `CNAME` レコードを作成します。そして、ターミナルから `dig` コマンドを叩いて、DNS レコードが正しく設定されたか確認します。
っていう説明をされて、「それはそう」って思った人はこの記事をこれ以上読む必要がないと思うので、別の記事を読むことをオススメします。全然関係ないんですけど、最近読んだ記事だと 「[【結論】TypeScriptの型定義はtypeよりinterfaceを使うべき理由](https://zenn.dev/bmth/articles/interface-props-extends)」 という記事が面白かったです。
さて、次の章では、用語の確認をしながら、先ほどのドキュメントが何を言っていたのか、噛み砕いていこうと思います。
# 用語の確認
## ドメイン/アペックスドメイン/サブドメイン
本当に基本的なところから始めますが、「ドメインって何？」って聞かれてパッと説明できますか？非常に残念なことに私は若干怪しいので、そこから確認していきたいと思います。
「ドメインって何？」って聞いたら多分だいたいどの LLM も「インターネット上の住所のこと」って答えると思います。確かにそう思っておけば、実際の住所として `東京都千代田区千代田1-1`、ドメイン（正確にはサブドメインがついたドメイン）として `www.example.com` を考えたときに、`東京都` が `.com` に、`千代田区` が `example` に、`千代田` が `www` に対応していると考えることができ、イメージがつきやすいですね。そして、この場合、`.com` を **TLD（トップレベルドメイン）**、`example` を **SLD（セカンドレベルドメイン）**、`www` を **サブドメイン**と言います。ただ、`www.example.com` のことをサブドメインと呼ぶ場合もあり、今回は先ほどの GitHub の公式ドキュメントに合わせて、そう呼ぶこととします。また、`example.com` のことを**アペックスドメイン**や**ネイキッドドメイン**と呼びます。
## DNS プロバイダー/DNS レコード
じゃあそのサイトのドメインが分かれば、そのサイトにアクセスできるのかっていうとそうじゃなくて、そのドメインのコンピューター用の住所（**IP アドレス**）を知る必要があります。喩えるなら、ドメインが「友達の名前」で IP アドレスが「友達の電話番号」です。名前だけ知っていても電話番号をかけられないように、名前と電話番号を対応づける「電話帳」が必要ですよね。そして、その電話帳が **DNS(Domain Name System)** で、その電話帳を貸してくれる会社が **DNS プロバイダー** といいます。この喩えは Gemini に考えてもらいました。そして、その電話帳の各行を **DNS レコード** と呼ぶのですが、DNS レコードにはいくつか種類があります。そのうち二つだけ紹介すると、以下のようになります。
|レコード名|正式名称|内容|
|----|----|----|
|A|Address|ドメインの IP アドレス（IPv4）|
|CNAME|Canonical Name|ドメインの正規名（別名）の定義|

今回は `www.example.com` の正規名として `<user>.github.io` を定義したいから `CNAME` レコードを設定するわけですね。
では、実際にどのようにして、ブラウザにドメインを入力してから、そのドメインの Web サイトにアクセスすることができるのでしょうか？[Cloudflare の公式教材](https://www.cloudflare.com/learning/dns/what-is-dns/)に則って、今回は `example.com` を例に見ていきましょう。まず、簡単にデータの流れだけ追っていきます。
1. ユーザがブラウザに `example.com` と入力。クエリがインターネットに送信され、**リゾルバー**によって受信される。
2. リゾルバーは **ルートサーバー** にリクエストを送信。
3. ルートサーバーは、リゾルバーに TLD の **ネームサーバー**のアドレスを返す。今回の TLD は `.com`
4. リゾルバは `.com` のネームサーバーにリクエストを送信。
5. `.com` のネームサーバーは `example.com` ドメインのネームサーバーの IP アドレスをレスポンスとして返す。
6. リゾルバは `example.com` ドメインのネームサーバーにリクエストを送信。
7. ネームサーバーは `example.com` の IP アドレスをレスポンスとして返す。
8. リゾルバは、最初に要求されたドメインの IP アドレスをブラウザにレスポンスとして返す。
9. ブラウザは IP アドレスに HTTP リクエストを送信。
10. サーバーが HTML CSS JavaScript をレスポンスとして返す。
図は、日本語で書き直しました。Figma は勉強中です。
![example.com](/images/example.com.png)

`www.example.com` のようなサブドメインの場合はどうなるでしょうか？サブドメインの場合は `example.com` のネームサーバーに問い合わせ、ネームサーバーは `www.example.com` の `CNAME` や `A` レコードを返します。`A` レコードが返された場合は、そのまま IP アドレスをブラウザに返しますが、`CNAME` レコードが返された場合はどうすればいいでしょうか？例えば、`www.example.com` の `CNAME` レコードが `<user>.github.io` だった場合、リゾルバーはもう一回最初から `<user>.github.io` の `A` レコードを探しにいけばいいですね。
## `dig` コマンド
`dig` コマンドを使えば、指定したドメイン名に対して、どんな DNS レコードが返ってくるか確認できます。ここでは `www.example.com` を例として、 試しにターミナルで `dig www.example.com` と実行してみましょう。
ANSWER SECTION を見てみると、私はこんな感じになりました。
```sh
www.example.com.        17      IN      CNAME   www.example.com-v4.edgesuite.net.
www.example.com-v4.edgesuite.net. 13 IN CNAME   a1422.dscr.akamai.net.
a1422.dscr.akamai.net.  17      IN      A       23.210.250.168
a1422.dscr.akamai.net.  17      IN      A       23.210.250.155
```
ここから、`www.example.com` の IP アドレスを問い合わせると、まず `www.example.com-v4.edgesuite.net` への `CNAME` が返されます。`www.example.com-v4.edgesuite.net` の IP アドレスを問い合わせると、 `a1422.dscr.akamai.net` への `CNAME` が返されます。`a1422.dscr.akamai.net` を問い合わせると、2 つの `A` レコード（`23.210.250.168` `23.210.250.155`）が返されているのが分かるかと思います。 

# まとめ
今回は DNS の簡単な復習とカスタムドメインの仕組みについて勉強しました。最後まで読んでいただきありがとうございました。